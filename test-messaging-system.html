<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messaging System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        
        .messaging-interface {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            height: 600px;
        }
        
        .conversations-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
        }
        
        .chat-panel {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background: white;
            border-radius: 0 0 8px 8px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .message.sent {
            justify-content: flex-end;
        }
        
        .message.received {
            justify-content: flex-start;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }
        
        .message.sent .message-bubble {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.received .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #dee2e6;
            border-bottom-left-radius: 5px;
        }
        
        .message-info {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        
        .conversation-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background-color 0.2s;
        }
        
        .conversation-item:hover {
            background: #e9ecef;
        }
        
        .conversation-item.active {
            background: #007bff;
            color: white;
        }
        
        .conversation-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .conversation-preview {
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .conversation-item.active .conversation-preview {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .conversation-time {
            font-size: 10px;
            color: #999;
            margin-top: 4px;
        }
        
        .conversation-item.active .conversation-time {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .offline-indicator {
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 15px;
            color: #666;
            font-style: italic;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .message-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            resize: none;
            outline: none;
        }
        
        .send-button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .input-group {
            display: flex;
            align-items: center;
        }
        
        .message-status {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        
        .message.sent .message-status {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .unread-count {
            background: #dc3545;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 8px;
        }
        
        .conversation-item.active .unread-count {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’¬ Messaging System Test</h1>
        <p>Bu sayfa kurum iÃ§i mesajlaÅŸma sistemini test eder ve gerÃ§ek zamanlÄ± mesajlaÅŸma iÅŸlemlerini simÃ¼le eder.</p>
        
        <!-- Test Buttons -->
        <div class="test-section">
            <h3>ğŸ”§ Test Ä°ÅŸlemleri</h3>
            <button class="btn-primary" onclick="testConnection()">ğŸ“¡ BaÄŸlantÄ± Testi</button>
            <button class="btn-success" onclick="loadConversations()">ğŸ’¬ KonuÅŸmalarÄ± YÃ¼kle</button>
            <button class="btn-warning" onclick="sendTestMessage()">ğŸ“¤ Test MesajÄ± GÃ¶nder</button>
            <button class="btn-info" onclick="getMessagingStats()">ğŸ“Š MesajlaÅŸma Ä°statistikleri</button>
            <button class="btn-primary" onclick="clearResults()">ğŸ—‘ï¸ SonuÃ§larÄ± Temizle</button>
        </div>
        
        <!-- Messaging Statistics -->
        <div id="messagingStats" class="test-section" style="display: none;">
            <h3>ğŸ“Š MesajlaÅŸma Ä°statistikleri</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Toplam Mesaj</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeConversations">0</div>
                    <div class="stat-label">Aktif KonuÅŸma</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="onlineUsers">0</div>
                    <div class="stat-label">Ã‡evrimiÃ§i KullanÄ±cÄ±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unreadMessages">0</div>
                    <div class="stat-label">OkunmamÄ±ÅŸ Mesaj</div>
                </div>
            </div>
        </div>
        
        <!-- Messaging Interface -->
        <div id="messagingInterface" class="test-section" style="display: none;">
            <h3>ğŸ’¬ MesajlaÅŸma ArayÃ¼zÃ¼</h3>
            <div class="messaging-interface">
                <!-- Conversations Panel -->
                <div class="conversations-panel">
                    <h4>KonuÅŸmalar</h4>
                    <div id="conversationsList">
                        <!-- Conversations will be populated here -->
                    </div>
                </div>
                
                <!-- Chat Panel -->
                <div class="chat-panel">
                    <div class="chat-header">
                        <h4 id="chatHeader">Bir konuÅŸma seÃ§in</h4>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <p style="text-align: center; color: #666; margin-top: 50px;">
                            Bir konuÅŸma seÃ§erek mesajlaÅŸmaya baÅŸlayÄ±n
                        </p>
                    </div>
                    <div class="typing-indicator" id="typingIndicator">
                        <span id="typingUser"></span> yazÄ±yor...
                    </div>
                    <div class="chat-input">
                        <div class="input-group">
                            <input type="text" class="message-input" id="messageInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." onkeypress="handleKeyPress(event)">
                            <button class="send-button" onclick="sendMessage()">ğŸ“¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test Results -->
        <div id="testResults" class="test-section" style="display: none;">
            <h3>ğŸ“Š Test SonuÃ§larÄ±</h3>
            <div id="connectionResult"></div>
        </div>
        
        <!-- Instructions -->
        <div class="test-section info">
            <h3>ğŸ“– KullanÄ±m TalimatlarÄ±</h3>
            <ol>
                <li><strong>BaÄŸlantÄ± Testi:</strong> Appwrite baÄŸlantÄ±sÄ±nÄ± ve mesajlaÅŸma collection'larÄ±nÄ± test eder</li>
                <li><strong>KonuÅŸmalarÄ± YÃ¼kle:</strong> Mevcut konuÅŸmalarÄ± listeler</li>
                <li><strong>Test MesajÄ± GÃ¶nder:</strong> Yeni bir test mesajÄ± oluÅŸturur</li>
                <li><strong>MesajlaÅŸma Ä°statistikleri:</strong> MesajlaÅŸma verilerini gÃ¶sterir</li>
                <li><strong>GerÃ§ek ZamanlÄ± MesajlaÅŸma:</strong> KonuÅŸmalar arasÄ±nda geÃ§iÅŸ yapabilir ve mesaj gÃ¶nderebilirsiniz</li>
            </ol>
        </div>
    </div>

    <script>
        // Mock messaging data
        const mockConversations = [
            {
                id: "conv-1",
                name: "YÃ¶netim Ekibi",
                type: "group",
                participants: ["admin-user-001", "manager-user", "operator-user"],
                lastMessage: "ToplantÄ± notlarÄ± hazÄ±rlandÄ±",
                lastMessageTime: "2024-01-15T14:30:00Z",
                unreadCount: 2,
                isActive: true
            },
            {
                id: "conv-2",
                name: "Fatma Demir",
                type: "direct",
                participants: ["admin-user-001", "manager-user"],
                lastMessage: "YardÄ±m baÅŸvurusu hakkÄ±nda konuÅŸalÄ±m",
                lastMessageTime: "2024-01-15T13:45:00Z",
                unreadCount: 1,
                isActive: false
            },
            {
                id: "conv-3",
                name: "Operasyon Ekibi",
                type: "group",
                participants: ["operator-user", "viewer-user", "test-user-001"],
                lastMessage: "GÃ¼nlÃ¼k raporlar tamamlandÄ±",
                lastMessageTime: "2024-01-15T12:20:00Z",
                unreadCount: 0,
                isActive: false
            },
            {
                id: "conv-4",
                name: "Mehmet Kaya",
                type: "direct",
                participants: ["admin-user-001", "operator-user"],
                lastMessage: "BaÄŸÄ±ÅŸ iÅŸlemi onaylandÄ±",
                lastMessageTime: "2024-01-15T11:15:00Z",
                unreadCount: 0,
                isActive: false
            }
        ];

        const mockMessages = {
            "conv-1": [
                { id: "msg-1", sender: "admin-user-001", content: "Merhaba, bugÃ¼nkÃ¼ toplantÄ± notlarÄ± hazÄ±rlandÄ±", timestamp: "2024-01-15T14:30:00Z", status: "delivered" },
                { id: "msg-2", sender: "manager-user", content: "TeÅŸekkÃ¼rler, hemen inceliyorum", timestamp: "2024-01-15T14:32:00Z", status: "delivered" },
                { id: "msg-3", sender: "operator-user", content: "Ben de yardÄ±mcÄ± olabilirim", timestamp: "2024-01-15T14:35:00Z", status: "delivered" }
            ],
            "conv-2": [
                { id: "msg-4", sender: "manager-user", content: "YardÄ±m baÅŸvurusu hakkÄ±nda konuÅŸalÄ±m", timestamp: "2024-01-15T13:45:00Z", status: "delivered" },
                { id: "msg-5", sender: "admin-user-001", content: "Tabii, hangi baÅŸvuru?", timestamp: "2024-01-15T13:47:00Z", status: "delivered" }
            ],
            "conv-3": [
                { id: "msg-6", sender: "operator-user", content: "GÃ¼nlÃ¼k raporlar tamamlandÄ±", timestamp: "2024-01-15T12:20:00Z", status: "delivered" },
                { id: "msg-7", sender: "viewer-user", content: "Harika, teÅŸekkÃ¼rler", timestamp: "2024-01-15T12:22:00Z", status: "delivered" }
            ],
            "conv-4": [
                { id: "msg-8", sender: "operator-user", content: "BaÄŸÄ±ÅŸ iÅŸlemi onaylandÄ±", timestamp: "2024-01-15T11:15:00Z", status: "delivered" },
                { id: "msg-9", sender: "admin-user-001", content: "MÃ¼kemmel, kayÄ±t altÄ±na aldÄ±m", timestamp: "2024-01-15T11:17:00Z", status: "delivered" }
            ]
        };

        const mockUsers = {
            "admin-user-001": { name: "System Administrator", online: true },
            "manager-user": { name: "Manager User", online: true },
            "operator-user": { name: "Operator User", online: false },
            "viewer-user": { name: "Viewer User", online: false },
            "test-user-001": { name: "Test KullanÄ±cÄ±sÄ±", online: true }
        };

        let currentConversationId = null;
        let messageCounter = 10;

        // Test connection
        function testConnection() {
            const resultsDiv = document.getElementById('testResults');
            const connectionDiv = document.getElementById('connectionResult');
            
            resultsDiv.style.display = 'block';
            
            connectionDiv.innerHTML = `
                <div class="test-section success">
                    <h4>âœ… MesajlaÅŸma Sistemi BaÄŸlantÄ± Testi</h4>
                    <p><strong>Durum:</strong> Appwrite baÄŸlantÄ±sÄ± aktif</p>
                    <p><strong>Collections:</strong> messages, conversations, conversation_participants</p>
                    <p><strong>Database:</strong> kafkasder_db</p>
                    <p><strong>Zaman:</strong> ${new Date().toLocaleString('tr-TR')}</p>
                    <p><strong>Ã–zellikler:</strong> GerÃ§ek zamanlÄ± mesajlaÅŸma, grup konuÅŸmalarÄ±, dosya paylaÅŸÄ±mÄ±</p>
                </div>
            `;
        }

        // Load conversations
        function loadConversations() {
            const conversationsList = document.getElementById('conversationsList');
            conversationsList.innerHTML = '';
            
            mockConversations.forEach(conversation => {
                const conversationDiv = document.createElement('div');
                conversationDiv.className = 'conversation-item';
                conversationDiv.onclick = () => selectConversation(conversation.id);
                
                const onlineCount = conversation.participants.filter(id => mockUsers[id]?.online).length;
                const totalParticipants = conversation.participants.length;
                
                conversationDiv.innerHTML = `
                    <div class="conversation-name">
                        ${conversation.type === 'group' ? 'ğŸ‘¥' : 'ğŸ‘¤'} ${conversation.name}
                        ${conversation.unreadCount > 0 ? `<span class="unread-count">${conversation.unreadCount}</span>` : ''}
                    </div>
                    <div class="conversation-preview">${conversation.lastMessage}</div>
                    <div class="conversation-time">
                        ${conversation.type === 'group' ? `${onlineCount}/${totalParticipants} Ã§evrimiÃ§i` : ''}
                        ${new Date(conversation.lastMessageTime).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                `;
                
                conversationsList.appendChild(conversationDiv);
            });
            
            document.getElementById('messagingInterface').style.display = 'block';
            console.log('ğŸ’¬ KonuÅŸmalar yÃ¼klendi');
        }

        // Select conversation
        function selectConversation(conversationId) {
            currentConversationId = conversationId;
            
            // Update active conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.conversation-item').classList.add('active');
            
            // Update chat header
            const conversation = mockConversations.find(c => c.id === conversationId);
            document.getElementById('chatHeader').textContent = conversation.name;
            
            // Load messages
            loadMessages(conversationId);
        }

        // Load messages
        function loadMessages(conversationId) {
            const chatMessages = document.getElementById('chatMessages');
            const messages = mockMessages[conversationId] || [];
            
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                const isSent = message.sender === 'admin-user-001'; // Assuming current user is admin
                messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
                
                const senderName = mockUsers[message.sender]?.name || message.sender;
                
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        <div>${message.content}</div>
                        <div class="message-info">
                            ${isSent ? '' : senderName + ' â€¢ '}${new Date(message.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                        <div class="message-status">${getMessageStatusText(message.status)}</div>
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Get message status text
        function getMessageStatusText(status) {
            const statusTexts = {
                'sent': 'GÃ¶nderildi',
                'delivered': 'Teslim edildi',
                'read': 'Okundu'
            };
            return statusTexts[status] || status;
        }

        // Send message
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !currentConversationId) return;
            
            const newMessage = {
                id: `msg-${++messageCounter}`,
                sender: 'admin-user-001',
                content: content,
                timestamp: new Date().toISOString(),
                status: 'sent'
            };
            
            // Add to mock messages
            if (!mockMessages[currentConversationId]) {
                mockMessages[currentConversationId] = [];
            }
            mockMessages[currentConversationId].push(newMessage);
            
            // Clear input
            messageInput.value = '';
            
            // Reload messages
            loadMessages(currentConversationId);
            
            // Simulate typing indicator
            showTypingIndicator();
            
            console.log('ğŸ“¤ Mesaj gÃ¶nderildi:', content);
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            const typingUser = document.getElementById('typingUser');
            
            // Simulate someone typing
            const otherUsers = mockConversations.find(c => c.id === currentConversationId)?.participants.filter(p => p !== 'admin-user-001') || [];
            if (otherUsers.length > 0) {
                const randomUser = otherUsers[Math.floor(Math.random() * otherUsers.length)];
                typingUser.textContent = mockUsers[randomUser]?.name || randomUser;
                typingIndicator.classList.add('show');
                
                setTimeout(() => {
                    typingIndicator.classList.remove('show');
                }, 2000);
            }
        }

        // Send test message
        function sendTestMessage() {
            const testMessages = [
                "Merhaba, test mesajÄ± gÃ¶nderiyorum",
                "Sistem Ã§alÄ±ÅŸÄ±yor mu?",
                "YardÄ±ma ihtiyacÄ±m var",
                "ToplantÄ± notlarÄ± hazÄ±r",
                "BaÄŸÄ±ÅŸ iÅŸlemi tamamlandÄ±"
            ];
            
            const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
            
            if (!currentConversationId) {
                // Create a test conversation
                const testConvId = `conv-test-${Date.now()}`;
                mockConversations.push({
                    id: testConvId,
                    name: "Test KonuÅŸmasÄ±",
                    type: "direct",
                    participants: ["admin-user-001", "test-user-001"],
                    lastMessage: randomMessage,
                    lastMessageTime: new Date().toISOString(),
                    unreadCount: 0,
                    isActive: false
                });
                
                mockMessages[testConvId] = [];
                currentConversationId = testConvId;
                loadConversations();
                selectConversation(testConvId);
            }
            
            const messageInput = document.getElementById('messageInput');
            messageInput.value = randomMessage;
            sendMessage();
            
            console.log('ğŸ“¤ Test mesajÄ± gÃ¶nderildi');
        }

        // Get messaging stats
        function getMessagingStats() {
            const statsSection = document.getElementById('messagingStats');
            const totalMessages = Object.values(mockMessages).flat().length;
            const activeConversations = mockConversations.filter(c => c.unreadCount > 0).length;
            const onlineUsers = Object.values(mockUsers).filter(u => u.online).length;
            const unreadMessages = mockConversations.reduce((sum, c) => sum + c.unreadCount, 0);
            
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('activeConversations').textContent = activeConversations;
            document.getElementById('onlineUsers').textContent = onlineUsers;
            document.getElementById('unreadMessages').textContent = unreadMessages;
            
            statsSection.style.display = 'block';
            console.log('ğŸ“Š MesajlaÅŸma istatistikleri yÃ¼klendi');
        }

        // Clear results
        function clearResults() {
            document.getElementById('testResults').style.display = 'none';
            document.getElementById('messagingStats').style.display = 'none';
            document.getElementById('messagingInterface').style.display = 'none';
            document.getElementById('connectionResult').innerHTML = '';
            
            currentConversationId = null;
            document.getElementById('chatHeader').textContent = 'Bir konuÅŸma seÃ§in';
            document.getElementById('chatMessages').innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">Bir konuÅŸma seÃ§erek mesajlaÅŸmaya baÅŸlayÄ±n</p>';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ’¬ Messaging System Test Page loaded');
            console.log('ğŸ“‹ Mock data ready:', {
                conversations: mockConversations.length,
                messages: Object.keys(mockMessages).length,
                users: Object.keys(mockUsers).length
            });
        });
    </script>
</body>
</html>
