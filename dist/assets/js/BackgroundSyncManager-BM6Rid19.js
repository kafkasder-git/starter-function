import{r as e,j as a,c3 as s,a8 as n,ba as t,c7 as i,_ as r,i as c,c8 as l,a0 as d,o,q as m}from"./react-vendor-Zi_jsHoK.js";import{A as y,f as h,u}from"./user-management-page-B6-AaFFc.js";import{l as g,a2 as v,a3 as k,C as p,a as f,b as w,e as N,c as x,B as b}from"./beneficiaries-page-CkZlrYV8.js";import{P as T}from"./events-finance-page-DWyC3OLf.js";import{S}from"./messaging-page-BEU6nUaR.js";import{T as z,a as $,b as j,c as B}from"./tabs-fYszpb1R.js";import"./ui-vendor-f6_gbUtQ.js";import"./utils-vendor-CH-VcvGo.js";import"./toast-vendor-Ci27VDWJ.js";import"./appwrite-vendor-Ct7vfU_L.js";import"./motion-vendor-iBxafAnt.js";const A=new class{syncTasks=new Map;isOnline=navigator.onLine;syncInProgress=!1;registration=null;constructor(){this.initialize()}async initialize(){try{this.loadSyncTasks(),window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),"serviceWorker"in navigator&&"sync"in window.ServiceWorkerRegistration.prototype?(this.registration=await navigator.serviceWorker.ready,g.info("Background sync service initialized")):g.warn("Background sync not supported"),this.isOnline&&await this.syncPendingTasks()}catch(e){g.error("Failed to initialize background sync service:",e)}}async addSyncTask(e,a,s,n={}){const t=`${e}_${a}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i={id:t,type:a,entity:e,data:s,timestamp:Date.now(),retryCount:0,maxRetries:n.maxRetries??3,status:"pending"};if(this.syncTasks.set(t,i),this.saveSyncTasks(),g.info(`Sync task added: ${t}`,i),this.isOnline&&!this.syncInProgress)await this.syncPendingTasks();else if(this.registration)try{await this.registration.sync.register("background-sync")}catch(r){g.error("Failed to register background sync:",r)}return t}removeSyncTask(e){const a=this.syncTasks.delete(e);return a&&this.saveSyncTasks(),a}getSyncTasks(){return Array.from(this.syncTasks.values())}getPendingSyncTasks(){return this.getSyncTasks().filter(e=>"pending"===e.status)}getFailedSyncTasks(){return this.getSyncTasks().filter(e=>"failed"===e.status)}async retryFailedTasks(){return this.getFailedSyncTasks().forEach(e=>{e.status="pending",e.retryCount=0}),this.saveSyncTasks(),await this.syncPendingTasks()}clearAllTasks(){this.syncTasks.clear(),this.saveSyncTasks()}clearCompletedTasks(){const e=new Map;this.syncTasks.forEach((a,s)=>{"completed"!==a.status&&e.set(s,a)}),this.syncTasks=e,this.saveSyncTasks()}async syncPendingTasks(){if(!this.isOnline||this.syncInProgress)return{success:!1,syncedTasks:[],failedTasks:[],errors:["Sync already in progress or offline"]};this.syncInProgress=!0;const e=[],a=[],s=[];try{const t=this.getPendingSyncTasks();g.info(`Starting sync of ${t.length} tasks`);const i=this.groupTasksByEntity(t);for(const[c,l]of i)try{const n=await this.syncEntityTasks(c,l);e.push(...n.synced),a.push(...n.failed),s.push(...n.errors)}catch(n){const e=`Failed to sync ${c}: ${n instanceof Error?n.message:"Unknown error"}`;s.push(e),g.error(e),l.forEach(e=>{e.status="failed",e.retryCount++,a.push(e)})}e.forEach(e=>{this.syncTasks.delete(e.id)}),this.saveSyncTasks();const r={success:0===s.length,syncedTasks:e,failedTasks:a,errors:s};return g.info("Sync completed:",r),r}catch(n){const t=`Sync process failed: ${n instanceof Error?n.message:"Unknown error"}`;return s.push(t),g.error(t),{success:!1,syncedTasks:e,failedTasks:a,errors:s}}finally{this.syncInProgress=!1}}groupTasksByEntity(e){const a=new Map;return e.forEach(e=>{a.has(e.entity)||a.set(e.entity,[]),a.get(e.entity).push(e)}),a}async syncEntityTasks(e,a){const s=[],n=[],t=[];a.sort((e,a)=>e.timestamp-a.timestamp);for(const r of a)try{if(r.status="syncing",!(await this.performSyncOperation(r)))throw new Error("Sync operation returned false");r.status="completed",s.push(r),g.info(`Task synced successfully: ${r.id}`)}catch(i){if(r.retryCount++,r.retryCount>=r.maxRetries){r.status="failed",n.push(r);const e=`Task failed after ${r.maxRetries} retries: ${r.id}`;t.push(e),g.error(e)}else{r.status="pending";const e=`Task retry ${r.retryCount}/${r.maxRetries}: ${r.id}`;t.push(e),g.warn(e)}}return{synced:s,failed:n,errors:t}}async performSyncOperation(e){switch(await new Promise(e=>setTimeout(e,100+500*Math.random())),e.entity){case"beneficiaries":return this.syncBeneficiary(e);case"donations":return this.syncDonation(e);case"members":return this.syncMember(e);case"activities":return this.syncActivity(e);default:return g.warn(`Unknown entity type for sync: ${e.entity}`),!1}}async syncBeneficiary(e){return g.info(`Syncing beneficiary ${e.type}:`,e.data),Math.random()>.1}async syncDonation(e){return g.info(`Syncing donation ${e.type}:`,e.data),Math.random()>.05}async syncMember(e){return g.info(`Syncing member ${e.type}:`,e.data),Math.random()>.15}async syncActivity(e){return g.info(`Syncing activity ${e.type}:`,e.data),Math.random()>.02}async handleOnline(){g.info("Device came online - starting sync"),this.isOnline=!0,await this.syncPendingTasks()}handleOffline(){g.info("Device went offline"),this.isOnline=!1}saveSyncTasks(){try{const e=Array.from(this.syncTasks.values());localStorage.setItem("backgroundSyncTasks",JSON.stringify(e))}catch(e){g.error("Failed to save sync tasks:",e)}}loadSyncTasks(){try{const a=localStorage.getItem("backgroundSyncTasks");if(a){try{const e=JSON.parse(a);this.syncTasks.clear(),e.forEach(e=>{"syncing"===e.status&&(e.status="pending"),this.syncTasks.set(e.id,e)})}catch(e){g.error("Failed to parse stored sync tasks:",e),localStorage.removeItem("backgroundSyncTasks"),this.syncTasks.clear()}g.info(`Loaded ${this.syncTasks.size} sync tasks from storage`)}}catch(a){g.error("Failed to load sync tasks:",a)}}getSyncStats(){const e=this.getSyncTasks();return{total:e.length,pending:e.filter(e=>"pending"===e.status).length,completed:e.filter(e=>"completed"===e.status).length,failed:e.filter(e=>"failed"===e.status).length,syncing:e.filter(e=>"syncing"===e.status).length}}isSyncAvailable(){return"serviceWorker"in navigator&&"sync"in window.ServiceWorkerRegistration.prototype}isDeviceOnline(){return this.isOnline}isSyncInProgress(){return this.syncInProgress}},C=({className:g=""})=>{const{isOnline:C,isSyncAvailable:E,isSyncInProgress:O,syncStats:D,pendingTasks:M,failedTasks:P,syncNow:F,retryFailedTasks:G,clearCompletedTasks:I,clearAllTasks:R,removeSyncTask:U,addSyncTask:Y}=(()=>{const[a,s]=e.useState(navigator.onLine),[n,t]=e.useState(!1),[i,r]=e.useState(A.getSyncStats()),[c,l]=e.useState([]),[d,o]=e.useState([]),m=e.useCallback(()=>{r(A.getSyncStats()),l(A.getPendingSyncTasks()),o(A.getFailedSyncTasks()),t(A.isSyncInProgress())},[]);e.useEffect(()=>{m();const e=()=>{s(!0),m()},a=()=>{s(!1),m()};window.addEventListener("online",e),window.addEventListener("offline",a);const n=setInterval(m,1e3);return()=>{window.removeEventListener("online",e),window.removeEventListener("offline",a),clearInterval(n)}},[m]);const y=e.useCallback(async(e,a,s,n)=>{const t=await A.addSyncTask(e,a,s,n);return m(),t},[m]),h=e.useCallback(async()=>{const e=await A.syncPendingTasks();return m(),e},[m]),u=e.useCallback(async()=>{const e=await A.retryFailedTasks();return m(),e},[m]),g=e.useCallback(()=>{A.clearCompletedTasks(),m()},[m]),v=e.useCallback(()=>{A.clearAllTasks(),m()},[m]),k=e.useCallback(e=>{const a=A.removeSyncTask(e);return m(),a},[m]);return{isOnline:a,isSyncAvailable:A.isSyncAvailable(),isSyncInProgress:n,syncStats:i,pendingTasks:c,failedTasks:d,addSyncTask:y,syncNow:h,retryFailedTasks:u,clearCompletedTasks:g,clearAllTasks:v,removeSyncTask:k}})(),{toast:_}=u(),[H,J]=e.useState(!1),V=async()=>{try{const e=await F();e.success?_({title:"Senkronizasyon Tamamlandı",description:`${e.syncedTasks.length} görev başarıyla senkronize edildi.`}):_({title:"Senkronizasyon Sorunları",description:`${e.failedTasks.length} görev başarısız oldu.`,variant:"destructive"})}catch{_({title:"Senkronizasyon Hatası",description:"Senkronizasyon işlemi başlatılamadı.",variant:"destructive"})}},W=e=>{switch(e){case"completed":return a.jsx(d,{className:"w-4 h-4 text-green-500"});case"failed":return a.jsx(m,{className:"w-4 h-4 text-red-500"});case"syncing":return a.jsx(t,{className:"w-4 h-4 text-blue-500 animate-spin"});default:return a.jsx(o,{className:"w-4 h-4 text-yellow-500"})}},q=e=>{switch(e){case"beneficiaries":return"👥";case"donations":return"💰";case"members":return"👤";case"activities":return"📝";default:return"📄"}},L=()=>0===D.total?0:(D.completed+D.failed)/D.total*100,K=({timestamp:s})=>{const n=function(a,s){const[n,t]=e.useState(()=>v(a)),i=e.useRef(null);return e.useEffect(()=>{t(v(a));const e=k(a);if(null!==e)return i.current=setInterval(()=>{t(v(a))},e),()=>{i.current&&(clearInterval(i.current),i.current=null)}},[a,s?.enabled,s?.updateInterval]),n}(s);return a.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:n})};return E?a.jsxs(p,{className:g,children:[a.jsxs(f,{children:[a.jsxs(w,{className:"flex items-center gap-2",children:[a.jsx(s,{className:"w-5 h-5"}),"Arka Plan Senkronizasyonu",O&&a.jsx(t,{className:"w-4 h-4 animate-spin text-blue-500"})]}),a.jsx(x,{children:"Offline veri senkronizasyonu ve görev yönetimi"})]}),a.jsxs(N,{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[C?a.jsx(i,{className:"w-5 h-5 text-green-500"}):a.jsx(r,{className:"w-5 h-5 text-red-500"}),a.jsxs("div",{children:[a.jsx("div",{className:"font-medium",children:C?"Çevrimiçi":"Çevrimdışı"}),a.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:C?"Senkronizasyon mevcut":"Veriler yerel olarak kaydediliyor"})]})]}),a.jsx("div",{className:"flex gap-2",children:a.jsxs(b,{onClick:V,disabled:!C||O,size:"sm",className:"gap-2",children:[a.jsx(t,{className:"w-4 h-4"}),"Şimdi Senkronize Et"]})})]}),a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[a.jsxs("div",{className:"text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:[a.jsx("div",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:D.total}),a.jsx("div",{className:"text-sm text-blue-600 dark:text-blue-400",children:"Toplam"})]}),a.jsxs("div",{className:"text-center p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg",children:[a.jsx("div",{className:"text-2xl font-bold text-yellow-600 dark:text-yellow-400",children:D.pending}),a.jsx("div",{className:"text-sm text-yellow-600 dark:text-yellow-400",children:"Bekleyen"})]}),a.jsxs("div",{className:"text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg",children:[a.jsx("div",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:D.completed}),a.jsx("div",{className:"text-sm text-green-600 dark:text-green-400",children:"Tamamlanan"})]}),a.jsxs("div",{className:"text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg",children:[a.jsx("div",{className:"text-2xl font-bold text-red-600 dark:text-red-400",children:D.failed}),a.jsx("div",{className:"text-sm text-red-600 dark:text-red-400",children:"Başarısız"})]})]}),D.total>0&&a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex justify-between text-sm",children:[a.jsx("span",{children:"Senkronizasyon İlerlemesi"}),a.jsxs("span",{children:[Math.round(L()),"%"]})]}),a.jsx(T,{value:L(),className:"h-2"})]}),a.jsxs(z,{defaultValue:"pending",className:"w-full",children:[a.jsxs($,{className:"grid w-full grid-cols-3",children:[a.jsxs(j,{value:"pending",children:["Bekleyen (",D.pending,")"]}),a.jsxs(j,{value:"failed",children:["Başarısız (",D.failed,")"]}),a.jsx(j,{value:"actions",children:"İşlemler"})]}),a.jsx(B,{value:"pending",children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h3",{className:"font-medium",children:"Bekleyen Görevler"}),M.length>0&&a.jsx(b,{onClick:V,disabled:!C||O,size:"sm",variant:"outline",children:"Hepsini Senkronize Et"})]}),a.jsx(S,{className:"h-64",children:0===M.length?a.jsx("div",{className:"text-center py-8 text-gray-500",children:"Bekleyen görev bulunmuyor"}):a.jsx("div",{className:"space-y-2",children:M.map(e=>a.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("span",{className:"text-lg",children:q(e.entity)}),a.jsxs("div",{children:[a.jsxs("div",{className:"font-medium",children:[e.entity," - ",e.type]}),a.jsx(K,{timestamp:e.timestamp})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[W(e.status),a.jsx(b,{onClick:()=>U(e.id),size:"sm",variant:"ghost",children:a.jsx(c,{className:"w-4 h-4"})})]})]},e.id))})})]})}),a.jsx(B,{value:"failed",children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h3",{className:"font-medium",children:"Başarısız Görevler"}),P.length>0&&a.jsx(b,{onClick:async()=>{try{const e=await G();e.success?_({title:"Başarısız Görevler Yeniden Denendi",description:`${e.syncedTasks.length} görev başarıyla senkronize edildi.`}):_({title:"Yeniden Deneme Sorunları",description:`${e.failedTasks.length} görev hala başarısız.`,variant:"destructive"})}catch{_({title:"Yeniden Deneme Hatası",description:"Başarısız görevler yeniden denenemedi.",variant:"destructive"})}},disabled:!C||O,size:"sm",variant:"outline",children:"Yeniden Dene"})]}),a.jsx(S,{className:"h-64",children:0===P.length?a.jsx("div",{className:"text-center py-8 text-gray-500",children:"Başarısız görev bulunmuyor"}):a.jsx("div",{className:"space-y-2",children:P.map(e=>a.jsxs("div",{className:"flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 rounded-lg",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("span",{className:"text-lg",children:q(e.entity)}),a.jsxs("div",{children:[a.jsxs("div",{className:"font-medium",children:[e.entity," - ",e.type]}),a.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:[e.retryCount,"/",e.maxRetries," deneme"]})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[W(e.status),a.jsx(b,{onClick:()=>U(e.id),size:"sm",variant:"ghost",children:a.jsx(c,{className:"w-4 h-4"})})]})]},e.id))})})]})}),a.jsx(B,{value:"actions",children:a.jsx("div",{className:"space-y-4",children:a.jsxs("div",{className:"grid gap-3",children:[a.jsxs(b,{onClick:async()=>{J(!0);try{const e=[{entity:"beneficiaries",type:"CREATE",data:{name:"Test Beneficiary",age:25}},{entity:"donations",type:"UPDATE",data:{id:"123",amount:1e3}},{entity:"members",type:"CREATE",data:{name:"Test Member",email:"test@example.com"}},{entity:"activities",type:"CREATE",data:{type:"login",timestamp:Date.now()}}];for(const a of e)await Y(a.entity,a.type,a.data);_({title:"Test Görevleri Oluşturuldu",description:`${e.length} test görevi senkronizasyon kuyruğuna eklendi.`})}catch{_({title:"Test Görevleri Oluşturulamadı",description:"Test görevleri oluşturulurken hata oluştu.",variant:"destructive"})}finally{J(!1)}},disabled:H,className:"gap-2",children:[a.jsx(l,{className:"w-4 h-4"}),"Test Görevleri Oluştur"]}),a.jsxs(b,{onClick:()=>{I(),_({title:"Tamamlanan Görevler Temizlendi",description:"Başarıyla senkronize edilen görevler kaldırıldı."})},variant:"outline",className:"gap-2",children:[a.jsx(d,{className:"w-4 h-4"}),"Tamamlanan Görevleri Temizle"]}),a.jsxs(b,{onClick:()=>{R(),_({title:"Tüm Görevler Temizlendi",description:"Senkronizasyon kuyruğu tamamen temizlendi."})},variant:"destructive",className:"gap-2",children:[a.jsx(c,{className:"w-4 h-4"}),"Tüm Görevleri Temizle"]})]})})})]})]})]}):a.jsxs(p,{className:g,children:[a.jsx(f,{children:a.jsxs(w,{className:"flex items-center gap-2",children:[a.jsx(s,{className:"w-5 h-5"}),"Arka Plan Senkronizasyonu"]})}),a.jsx(N,{children:a.jsxs(y,{children:[a.jsx(n,{className:"w-4 h-4"}),a.jsx(h,{children:"Bu tarayıcı arka plan senkronizasyonunu desteklemiyor."})]})})]})};export{C as default};
